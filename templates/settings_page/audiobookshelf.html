{% extends "settings_page/base.html" %}
{% block head %}
  <title>Settings - Audiobookshelf</title>
  {% include "scripts/alpinejs.html" %}
{% endblock head %}
{% block content %}
  <div class="flex flex-col gap-2">
    <h2 class="text-lg">Audiobookshelf</h2>
    <label for="abs-api-token">API Token</label>
    <form class="join w-full"
          hx-put="{{ base_url }}/settings/audiobookshelf/api-token"
          hx-disabled-elt="#abs-api-token-button">
      <input id="abs-api-token"
             name="api_token"
             type="password"
             {% if abs_api_token %}placeholder="●●●●●●●●●●●●●●●●●"{% endif %}
             class="input join-item w-full"
             minlength="1"
             required />
      <button id="abs-api-token-button" class="join-item btn">
        {% if abs_api_token %}
          Update
        {% else %}
          Add
        {% endif %}
      </button>
    </form>

    <label for="abs-base-url" class="pt-2">Base URL</label>
    <form class="join w-full"
          hx-put="{{ base_url }}/settings/audiobookshelf/base-url"
          hx-disabled-elt="#abs-base-url-button">
      <input id="abs-base-url"
             name="base_url"
             type="url"
             value="{{ abs_base_url }}"
             class="input join-item w-full"
             minlength="1"
             required />
      <button id="abs-base-url-button" class="join-item btn">
        {% if abs_base_url %}
          Update
        {% else %}
          Add
        {% endif %}
      </button>
    </form>

    <label for="abs-library" class="pt-2">Library</label>
    <form class="join w-full"
          hx-put="{{ base_url }}/settings/audiobookshelf/library"
          hx-disabled-elt="#abs-library-button">
      <select id="abs-library" name="library_id" class="select join-item w-full">
        {% if not abs_libraries or not abs_libraries|length %}
          <option disabled selected>Enter URL and API token first</option>
        {% endif %}
        {% for lib in abs_libraries %}
          <option value="{{ lib.id }}" {% if abs_library_id == lib.id %}selected{% endif %}>{{ lib.name }} ({{ lib.mediaType }})</option>
        {% endfor %}
      </select>
      <button id="abs-library-button" class="join-item btn">Save</button>
    </form>

    <div class="form-control pt-4">
      <label class="label cursor-pointer">
        <span class="label-text">Use ABS to mark existing books as downloaded</span>
        <form hx-put="{{ base_url }}/settings/audiobookshelf/check-downloaded">
          <input type="hidden" name="check_downloaded" value="0" />
          <input type="checkbox" name="check_downloaded" class="toggle" value="1"
                 {% if abs_check_downloaded %}checked{% endif %}
                 onchange="this.form.submit()" />
        </form>
      </label>
      <p class="text-xs opacity-60">When enabled, search results will be checked against Audiobookshelf and marked as downloaded if found to avoid duplicate requests.</p>
    </div>
  </div>
{% endblock content %}
